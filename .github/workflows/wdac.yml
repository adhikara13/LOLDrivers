name: Generate WDAC Policies

on: 
  push:
    branches:
      - "*"
  pull_request:
    branches: [main, test-branch]

jobs:
  generate-wdac:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: false
        lfs: true
    - name: Create audit policy
      shell: powershell
      run: |
        if(!(Test-Path -Path .\detections\wdac\)){
          New-Item -ItemType Directory -Path .\detections\wdac\ -Force
        }
        Get-ChildItem .\drivers\*.bin | Rename-Item -newname { $_.name -replace '.bin','.sys' };
        New-CIPolicy -Audit -ScanPath .\drivers\ -UserPEs -Level Hash -FilePath .\detections\wdac\AuditPolicy.xml
    - name: Create deny policy
      shell: powershell
      run: |
        if(!(Test-Path -Path .\detections\wdac\)){
          New-Item -ItemType Directory -Path .\detections\wdac\ -Force
        }
        Get-ChildItem .\drivers\*.bin | Rename-Item -newname { $_.name -replace '.bin','.sys' };
        $drivers = Get-SystemDriver -ScanPath .\drivers\ -NoShadowCopy;
        $NewDriverRules = New-CIPolicyRule -DriverFiles $drivers -Level Hash;
        Merge-CIPolicy -OutputFilePath .\detections\wdac\DenyPolicy.xml -PolicyPaths C:\Windows\schemas\CodeIntegrity\ExamplePolicies\AllowAll.xml -Rules $NewDriverRules | Out-Null;
    - name: Create supplemental policy
      shell: powershell
      run: |
        # Create supplemental policy based on the deny policy
        ConvertFrom-CIPolicy -XmlFilePath .\detections\wdac\DenyPolicy.xml -BinaryFilePath .\detections\wdac\SupplementalPolicy.bin
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: WDAC Policies
        path: ./detections/wdac/*
