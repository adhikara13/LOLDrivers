name: Generate WDAC Policies

on: 
  push:
    branches:
      - "*"
  pull_request:
    branches: [main, test-branch]

jobs:
  generate-wdac:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: false
        lfs: true
    - name: Create audit policy
      shell: powershell
      run: |
        if(!(Test-Path -Path .\detections\wdac\)){
          New-Item -ItemType Directory -Path .\detections\wdac\ -Force
        }
        Get-ChildItem .\drivers\*.bin | Rename-Item -newname { $_.name -replace '.bin','.sys' };
        New-CIPolicy -Audit -ScanPath .\drivers\ -UserPEs -Level Hash -FilePath .\detections\wdac\AuditPolicy.xml
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: WDAC Policies
        path: ./detections/wdac/*.xml
